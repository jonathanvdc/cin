using System;
using System.Collections.Generic;
using System.Text;
using Flame.Compiler;
using Flame.C.Lexer;

namespace Flame.C.Preprocessor
{
    public class PreprocessorState
    {
        public const this(set PreprocessorEnvironment Environment)
        {
            this.defs = new List<DefineDirective>();
        }

        public PreprocessorEnvironment Environment { const get; private set; }

        private List<DefineDirective> defs;
        public [DefineDirective] Definitions { const get return defs; }

        public void Define(DefineDirective Directive)
        {
            Undefine(Directive.Name);
            defs.Add(Directive);
        }
        public void Undefine(string Name)
        {
            for (int i = 0; i < defs.Count; i++)
            {
                if (defs[i].Name.Equals(Name))
                {
                    defs.RemoveAt(i);
                    i--;
                }
            }
        }

        public TokenStreamBuilder Expand(ITokenStream Reader)
        {
            var preprocessor = new PreprocessorInstance(Reader, this);
            preprocessor.Process();
            return preprocessor.Builder;
        }
        public TokenStreamBuilder Expand(SourceChunk Chunk)
        {
            var chunkReader = new ChunkReader(Chunk);
            return Expand(chunkReader);
        }
        public TokenStreamBuilder Expand(ISourceReader Reader)
        {
            var tokenizer = new PreprocessorTokenizerStream(Reader);
            return Expand(tokenizer);
        }
        public TokenStreamBuilder Expand(ISourceDocument Document)
        {
            var text = Document.Source;
            var reader = new ChunkReader(new SourceChunk(text, new SourceLocation(Document, 0, text.Length)));
            return Expand(reader.PreprocessCharacters(Environment.Log));
        }
    }
}
